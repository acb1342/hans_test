<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="adminMain">

    <!-- 설치자 메인 -->
    <select id="selectWorkerMain" parameterType="String" resultType="map">
        SELECT /* adminMain.selectWorkerMain */
              A.*
            , A.applCompleteCnt + A.brokCompleteCnt AS totalWkCnt
        FROM
            (
            SELECT
	              NOW() AS refDt
	            , (SELECT COUNT(*) FROM TB_ELCG_STATION_APPLICATION WHERE WK_USID = ma.ADMIN_ID AND STATUS = '407102') AS totalApplCnt
	            , (SELECT COUNT(*) FROM TB_ELCG_BROKEN_REPORT WHERE WK_USID = ma.ADMIN_ID AND STATUS = '409102') AS totalBrokCnt
	            , DATE_FORMAT(NOW(), '%Y.%m.01') AS workStartDt
	            , DATE_FORMAT(LAST_DAY(NOW()), '%Y.%m.%d') AS workEndDt
	            , (SELECT COUNT(*) FROM TB_ELCG_STATION_APPLICATION WHERE WK_USID = ma.ADMIN_ID AND STATUS = '407103' AND DATE(WK_DT) >= DATE_FORMAT(NOW(), '%Y-%m-01') AND DATE(WK_DT) &lt;= LAST_DAY(NOW()) ) AS applCompleteCnt
	            <!-- , (SELECT COUNT(*) FROM TB_ELCG_CHARGER WHERE FST_RG_USID = ma.ADMIN_ID AND DATE(FST_RG_DT) >= DATE_FORMAT(NOW(), '%Y-%m-01') AND DATE(FST_RG_DT) &lt;= LAST_DAY(NOW())) AS applCompleteCnt -->
	            , (SELECT COUNT(*) FROM TB_ELCG_BROKEN_REPORT WHERE WK_USID = ma.ADMIN_ID AND STATUS = '409103' AND DATE(WK_DT) >= DATE_FORMAT(NOW(), '%Y-%m-01') AND DATE(WK_DT) &lt;= LAST_DAY(NOW()) ) AS brokCompleteCnt
            FROM TB_MGMT_ADMIN ma
            WHERE ADMIN_ID = #{adminId}
            ) A
    </select>
    
    
    <!-- 충전기신청 조회 -->
    <select id="selectStationApplcation" parameterType="String" resultType="map">
        SELECT /* adminMain.selectStationApplcation */
              SN_ID as snId
            , CONCAT( (SELECT NAME FROM TB_ELCG_BD_GROUP WHERE BD_GROUP_ID = esa.BD_GROUP_ID), ' ', (SELECT NAME FROM TB_ELCG_BD WHERE BD_ID = esa.BD_ID) ) AS name
			, OD_DT AS odDt
            , STATUS AS status
		FROM TB_ELCG_STATION_APPLICATION esa
        WHERE WK_USID = #{adminId}
            AND STATUS = '407102'
        ORDER BY LST_CH_DT ASC
    </select>
    
    
    <!-- 고장신고 조회 -->
    <select id="selectBrokenReport" parameterType="String" resultType="map">
        SELECT /* adminMain.selectBrokenReport */
              SN_ID as snId
            , CONCAT( (SELECT NAME FROM TB_ELCG_BD_GROUP WHERE BD_GROUP_ID = ebr.BD_GROUP_ID), ' ', (SELECT NAME FROM TB_ELCG_BD WHERE BD_ID = ebr.BD_ID) ) AS name
			, OD_DT AS odDt
            , STATUS AS status
		FROM TB_ELCG_BROKEN_REPORT ebr
        WHERE WK_USID = #{adminId}
            AND STATUS = '409102'
        ORDER BY LST_CH_DT ASC
    </select>
    
    <!-- 건물주 메인 -->
    <select id="selectOwnerMain" parameterType="String" resultType="map">
        SELECT /* adminMain.selectOwnerMain */
			  NOW() AS refDt
			, (SELECT COUNT(*) FROM TB_ELCG_CHARGER WHERE CHARGER_GROUP_ID IN (SELECT CHARGER_GROUP_ID FROM TB_ELCG_CHARGER_GROUP WHERE BD_ID IN (SELECT BD_ID FROM TB_ELCG_BD WHERE ADMIN_ID = ma.ADMIN_ID))) AS totalChragerCnt
			, (SELECT COUNT(*) FROM TB_ELCG_CHARGER WHERE CHARGER_GROUP_ID IN (SELECT CHARGER_GROUP_ID FROM TB_ELCG_CHARGER_GROUP WHERE BD_ID IN (SELECT BD_ID FROM TB_ELCG_BD WHERE ADMIN_ID = ma.ADMIN_ID)) AND STATUS = '406101') AS instantChargeCnt
			, (SELECT COUNT(*) FROM TB_ELCG_CHARGER WHERE CHARGER_GROUP_ID IN (SELECT CHARGER_GROUP_ID FROM TB_ELCG_CHARGER_GROUP WHERE BD_ID IN (SELECT BD_ID FROM TB_ELCG_BD WHERE ADMIN_ID = ma.ADMIN_ID)) AND STATUS = '406102') AS waitingChargeCnt
			, (SELECT COUNT(*) FROM TB_ELCG_CHARGER WHERE CHARGER_GROUP_ID IN (SELECT CHARGER_GROUP_ID FROM TB_ELCG_CHARGER_GROUP WHERE BD_ID IN (SELECT BD_ID FROM TB_ELCG_BD WHERE ADMIN_ID = ma.ADMIN_ID)) AND STATUS = '406103') AS chargingCnt
			, (SELECT COUNT(*) FROM TB_ELCG_CHARGER WHERE CHARGER_GROUP_ID IN (SELECT CHARGER_GROUP_ID FROM TB_ELCG_CHARGER_GROUP WHERE BD_ID IN (SELECT BD_ID FROM TB_ELCG_BD WHERE ADMIN_ID = ma.ADMIN_ID)) AND STATUS = '406104') AS chargerErrorCnt
			, (SELECT COUNT(*) FROM TB_ELCG_STATION_APPLICATION WHERE RC_USID = ma.ADMIN_ID) AS totalApplCnt
            , (SELECT COUNT(*) FROM TB_ELCG_STATION_APPLICATION WHERE RC_USID = ma.ADMIN_ID AND STATUS = '407101') AS applAcceptingCnt
			, (SELECT COUNT(*) FROM TB_ELCG_STATION_APPLICATION WHERE RC_USID = ma.ADMIN_ID AND STATUS = '407102') AS applProgressCnt
			, (SELECT COUNT(*) FROM TB_ELCG_STATION_APPLICATION WHERE RC_USID = ma.ADMIN_ID AND STATUS = '407103') AS applCompleteCnt
			, (SELECT COUNT(*) FROM TB_ELCG_BROKEN_REPORT WHERE RC_USID = ma.ADMIN_ID) AS totalBrokCnt
			, (SELECT COUNT(*) FROM TB_ELCG_BROKEN_REPORT WHERE RC_USID = ma.ADMIN_ID AND STATUS = '409101') AS brokAcceptingCnt
			, (SELECT COUNT(*) FROM TB_ELCG_BROKEN_REPORT WHERE RC_USID = ma.ADMIN_ID AND STATUS = '409102') AS brokProgressCnt
			, (SELECT COUNT(*) FROM TB_ELCG_BROKEN_REPORT WHERE RC_USID = ma.ADMIN_ID AND STATUS = '409103') AS brokCompleteCnt
			, (SELECT COUNT(*) FROM TB_ELCG_BD WHERE ADMIN_ID = ma.ADMIN_ID) AS totalBdCnt
			, (SELECT COUNT(*) FROM TB_ELCG_CHARGER_GROUP WHERE BD_ID IN (SELECT BD_ID FROM TB_ELCG_BD WHERE ADMIN_ID = ma.ADMIN_ID)) AS totalChargerGrpCnt
		FROM TB_MGMT_ADMIN ma
		WHERE ma.ADMIN_ID = #{adminId}
    </select>
    
</mapper>
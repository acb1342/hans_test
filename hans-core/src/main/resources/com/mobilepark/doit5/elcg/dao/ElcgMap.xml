<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="elcg">

	<resultMap id="bdGroupListResultMap" type="map">
		<id property="bdGroupId" column="BD_GROUP_ID" />
		<result property="name" column="NAME" />
		<result property="zipcode" column="ZIPCODE" />
		<result property="addr" column="ADDR" />
		<result property="latitude" column="LATITUDE" />
		<result property="longitude" column="LONGITUDE" />
		<result property="fstRgUsid" column="FST_RG_USID" />
		<result property="fstRgDt" column="FST_RG_DT" />
		<result property="lstChUsid" column="LST_CH_USID" />
		<result property="lstChDt" column="LST_CH_DT" />
		<collection property="bdList" select="elcg.selectBdList" javaType="ArrayList" column="{bdGroupId=BD_GROUP_ID,usid=USID}" />
	</resultMap>
	
	<resultMap id="bdListResultMap" type="map">
		<id property="bdId" column="BD_ID" />
		<result property="name" column="NAME" />
		<result property="adminId" column="ADMIN_ID" />
		<result property="zipcode" column="ZIPCODE" />
		<result property="addr" column="ADDR" />
		<result property="latitude" column="LATITUDE" />
		<result property="longitude" column="LONGITUDE" />
		<result property="status" column="STATUS" />
		<result property="fstRgUsid" column="FST_RG_USID" />
		<result property="fstRgDt" column="FST_RG_DT" />
		<result property="lstChUsid" column="LST_CH_USID" />
		<result property="lstChDt" column="LST_CH_DT" />
		<result property="favoriteYn" column="FAVORITE_YN" />
	</resultMap>
	
    <select id="selectBdGroupList" resultMap="bdGroupListResultMap">
        SELECT /* elcg.selectBdGroupList */
        	  EBG.BD_GROUP_ID
        	, EBG.NAME
        	, EBG.ZIPCODE
        	, EBG.ADDR
        	, EBG.LATITUDE
        	, EBG.LONGITUDE
        	, EBG.FST_RG_USID
        	, EBG.FST_RG_DT
        	, EBG.LST_CH_USID
        	, EBG.LST_CH_DT
        	, #{usid} AS USID
        FROM TB_ELCG_BD_GROUP EBG
        <where>
	        <if test="searchKeyword != null and searchKeyword != ''">
	        	AND EBG.NAME LIKE CONCAT(CONCAT('%', #{searchKeyword}), '%')
	        </if>
        </where>
    </select>
    
    <select id="selectBdList" parameterType="map" resultMap="bdListResultMap">
        SELECT /* elcg.selectBdList */
        	  EB.BD_ID
        	, EB.NAME
        	, EB.ADMIN_ID
        	, EB.ZIPCODE
        	, EB.ADDR
        	, EB.LATITUDE
        	, EB.LONGITUDE
        	, EB.STATUS
        	, EB.FST_RG_USID
        	, EB.FST_RG_DT
        	, EB.LST_CH_USID
        	, EB.LST_CH_DT
        	, CASE WHEN EXISTS(SELECT 1 FROM TB_CUST_FAVORITES WHERE BD_ID = EB.BD_ID AND USID = #{usid})
        		THEN 'Y'
        		ELSE 'N'
        	  END AS FAVORITE_YN
        FROM TB_ELCG_BD EB
        WHERE EB.BD_GROUP_ID = #{bdGroupId}
    </select>
    
	<resultMap id="favoriteBdGroupListResultMap" type="map">
		<id property="bdGroupId" column="BD_GROUP_ID" />
		<result property="name" column="NAME" />
		<result property="addr" column="ADDR" />
		<collection property="bdList" select="elcg.selectFavoriteBdList" javaType="ArrayList" column="{bdGroupId=BD_GROUP_ID,usid=USID}" />
	</resultMap>
	
	<resultMap id="favoriteBdListResultMap" type="map">
		<id property="bdId" column="BD_ID" />
		<result property="name" column="NAME" />
		<result property="instantCharge" column="INSTANT_CHARGE" />
		<result property="waitingCharge" column="WAITING_CHARGE" />
		<result property="charging" column="CHARGING" />
	</resultMap>
	
    <select id="selectFavoriteBdGroupList" parameterType="long" resultMap="favoriteBdGroupListResultMap">
        SELECT /* elcg.selectFavoriteBdGroupList */
        	  EBG.BD_GROUP_ID
        	, EBG.NAME
        	, EBG.ADDR
        	, #{usid} AS USID
        FROM TB_ELCG_BD_GROUP EBG
	    WHERE EBG.BD_GROUP_ID IN (SELECT BD_GROUP_ID FROM TB_ELCG_BD WHERE BD_ID IN (SELECT BD_ID FROM TB_CUST_FAVORITES WHERE USID = #{usid}))
    </select>
    
    <select id="selectFavoriteBdList" parameterType="map" resultMap="favoriteBdListResultMap">
        SELECT /* elcg.selectFavoriteBdList */
        	  EB.BD_ID
        	, EB.NAME
        	, (SELECT COUNT(*) FROM TB_ELCG_CHARGER WHERE CHARGER_GROUP_ID IN (SELECT CHARGER_GROUP_ID FROM TB_ELCG_CHARGER_GROUP WHERE BD_ID = EB.BD_ID) AND STATUS = '406101') AS INSTANT_CHARGE
    		, (SELECT COUNT(*) FROM TB_ELCG_CHARGER WHERE CHARGER_GROUP_ID IN (SELECT CHARGER_GROUP_ID FROM TB_ELCG_CHARGER_GROUP WHERE BD_ID = EB.BD_ID) AND STATUS = '406102') AS WAITING_CHARGE
    		, (SELECT COUNT(*) FROM TB_ELCG_CHARGER WHERE CHARGER_GROUP_ID IN (SELECT CHARGER_GROUP_ID FROM TB_ELCG_CHARGER_GROUP WHERE BD_ID = EB.BD_ID) AND STATUS IN ('406103', '406104')) AS CHARGING
        FROM TB_ELCG_BD EB
        WHERE EB.BD_GROUP_ID = #{bdGroupId}
        ORDER BY CASE WHEN EB.BD_ID IN (SELECT BD_ID FROM TB_CUST_FAVORITES WHERE USID = #{usid}) THEN 1 ELSE 2 END, EB.NAME
    </select>
    
    <resultMap id="bdGroupDetailResultMap" type="map">
		<id property="bdGroupId" column="BD_GROUP_ID" />
		<result property="name" column="NAME" />
		<result property="addr" column="ADDR" />
	</resultMap>
    
    <resultMap id="bdGroupDetailBdListResultMap" type="map">
		<id property="bdId" column="BD_ID" />
		<result property="name" column="NAME" />
		<result property="instantCharge" column="INSTANT_CHARGE" />
		<result property="waitingCharge" column="WAITING_CHARGE" />
		<result property="charging" column="CHARGING" />
		<collection property="chargerList" select="elcg.selectChargerList" javaType="ArrayList" column="{bdId=BD_ID}" />
	</resultMap>
    
    <resultMap id="chargerListResultMap" type="map">
		<id property="chargerId" column="CHARGER_ID" />
		<result property="name" column="NAME" />
		<result property="status" column="STATUS" />
	</resultMap>
    
    <select id="selectBdGroupDetail" parameterType="Long" resultMap="bdGroupDetailResultMap">
    	SELECT /* elcg.selectBdGroupDetail */
    		  BD_GROUP_ID
    		, NAME
    		, ADDR
    	FROM TB_ELCG_BD_GROUP
    	WHERE BD_GROUP_ID = #{bdGroupId}
    </select>
    
    <select id="selectBdGroupDetailBdList" parameterType="Map" resultMap="bdGroupDetailBdListResultMap">
    	SELECT /* elcg.selectBdGroupDetailBdList */
    		  EB.BD_ID
    		, EB.NAME
    		, (SELECT COUNT(*) FROM TB_ELCG_CHARGER WHERE CHARGER_GROUP_ID IN (SELECT CHARGER_GROUP_ID FROM TB_ELCG_CHARGER_GROUP WHERE BD_ID = EB.BD_ID) AND STATUS = '406101') AS INSTANT_CHARGE
    		, (SELECT COUNT(*) FROM TB_ELCG_CHARGER WHERE CHARGER_GROUP_ID IN (SELECT CHARGER_GROUP_ID FROM TB_ELCG_CHARGER_GROUP WHERE BD_ID = EB.BD_ID) AND STATUS = '406102') AS WAITING_CHARGE
    		, (SELECT COUNT(*) FROM TB_ELCG_CHARGER WHERE CHARGER_GROUP_ID IN (SELECT CHARGER_GROUP_ID FROM TB_ELCG_CHARGER_GROUP WHERE BD_ID = EB.BD_ID) AND STATUS IN ('406103', '406104')) AS CHARGING
    	FROM TB_ELCG_BD EB
    	WHERE BD_GROUP_ID = #{bdGroupId}
    	ORDER BY
   		<if test="bdId != null and bdId != ''">
   			CASE WHEN EB.BD_ID = #{bdId} THEN 1 ELSE 2 END, 
   		</if>
   		EB.NAME
    </select>
    
    <select id="selectChargerList" parameterType="Map" resultMap="chargerListResultMap">
    	SELECT /* elcg.selectChargerList */
    		  CHARGER_ID
    		, STATUS
    		, NAME
    	FROM TB_ELCG_CHARGER
    	WHERE CHARGER_GROUP_ID IN (SELECT CHARGER_GROUP_ID FROM TB_ELCG_CHARGER_GROUP WHERE BD_ID = #{bdId})
    	  AND STATUS IN ('406101', '406102')
    	ORDER BY CASE WHEN STATUS = '406101' THEN 1 ELSE 2 END, NAME
    </select>
    
    <!-- 충전상태 count 조회 -->
    <select id="selectChargerStatusDetailCnt" parameterType="Map" resultType="int">
    	SELECT /* elcg.selectChargerStatusDetailCnt */
    		  COUNT(*) cnt
    	FROM TB_ELCG_CHARGE_STATUS
    	WHERE USID = #{usid}
    </select>
    
    <!-- 충전상태 수정 -->
    <update id="updateChargerStatus" parameterType="Map">
    	UPDATE /* elcg.updateChargerStatus */
    		TB_ELCG_CHARGE_STATUS
    		  SET 
                  STATUS = #{status}
                , CHARGE_AMT = #{chargeAmt}
                , CHARGE_FEE = #{chargeFee}
                , LST_CH_USID = #{lstChUsid}
                , LST_CH_DT = NOW()
                <if test='startCd != null and startCd == "3"'>
                    , START_DT = NOW()
                </if>
                <if test="chargeCond != null and chargeCond != ''">
                     , CHARGE_COND = #{chargeCond}
                  </if>
    	WHERE USID = #{usid}
    	    AND CHARGER_ID = #{chargerId}
    </update>
    
    <!-- 충전상태 등록 -->
    <insert id="insertChargerStatus" parameterType="Map">
    	INSERT /* elcg.insertChargerStatus */
    	INTO TB_ELCG_CHARGE_STATUS
    		  (
	    		    CHARGER_ID
	    		  , USID
	    		  , STATUS
	    		  <if test='startCd != null and startCd == "3"'>
	    		     , START_DT
	    		  </if>
	    		  <if test="chargeCond != null and chargeCond != ''">
	    		     , CHARGE_COND
	    		  </if>
	    		  , CHARGE_AMT
	    		  , CHARGE_FEE
	    		  , FST_RG_USID
	    		  , FST_RG_DT
	    		  , LST_CH_USID
	    		  , LST_CH_DT
    		  )
    		  VALUES
    		  (
    		        #{chargerId}
    		      , #{usid}
    		      , #{status}
    		      <if test='startCd != null and startCd == "3"'>
    		          , NOW()
    		      </if>
    		      <if test="chargeCond != null and chargeCond != ''">
                     , #{chargeCond}
                  </if>
    		      , #{chargeAmt}
    		      , #{chargeFee}
    		      , #{fstRgUsid}
    		      , NOW()
    		      , #{lstChUsid}
    		      , NOW()
    		  )
    </insert>
    
    <!-- 충전상태 삭제 -->
    <select id="deleteChargerStatus" parameterType="Map" resultType="int">
        DELETE /* elcg.deleteChargerStatus */
        FROM TB_ELCG_CHARGE_STATUS
        WHERE USID = #{usid}
    </select>
    
    
    <!-- 충전상태 조회 -->
    <select id="selectChargerStatusDetail" parameterType="Map" resultType="Map">
        SELECT /* elcg.selectChargerStatusDetail */
	          STATUS as chargeStatus
	        , CASE WHEN STATUS = '406102' THEN '충전 대기 중' WHEN STATUS = '406103' THEN '충전 전' ELSE '' END as chargeStatusNm
	        , START_DT as chargeStartTime
	        , TRUNCATE(CHARGE_AMT / 1000, 1) as chargeElecAmount
	        , CHARGE_FEE as chargeFee
	        , NOW() as refDt
        FROM TB_ELCG_CHARGE_STATUS
        WHERE USID = #{usid}
    </select>
    
    <!-- 충전상태 조회 -->
    <select id="selectChargerStatus" parameterType="Map" resultType="Map">
        SELECT /* elcg.selectChargerStatus */
            STATUS as status
        FROM TB_ELCG_CHARGE_STATUS
        WHERE USID = #{usid}
    </select>
    
    <insert id="insertCharger" parameterType="com.mobilepark.doit5.elcg.model.Charger">
    	INSERT /* elcg.insertCharger */
    	INTO TB_ELCG_CHARGER (
			  CHARGER_ID
			, CHARGER_GROUP_ID
			, NAME
			, MGMT_NO
			, CAPACITY
			, CHARGE_RATE
			, STATUS
			, DETAIL_STATUS
			, FST_RG_USID
			, FST_RG_DT
			, LST_CH_USID
			, LST_CH_DT
		) VALUES (
			  #{chargerId}
			, #{chargerGroupId}
			, #{name}
			, #{mgmtNo}
			, #{capacity}
			, #{chargeRate}
			, #{status}
			, #{detailStatus}
			, #{fstRgUsid}
			, NOW()
			, #{lstChUsid}
			, NOW()
		)
    </insert>
    
    <update id="updateChargerListStatus" parameterType="com.mobilepark.doit5.elcg.model.ChargerList">
    	UPDATE /* elcg.updateChargerListStatus */
    	TB_ELCG_CHARGER_LIST
    	SET	  STATUS = #{status}
    		, LST_CH_USID = #{lstChUsid}
    		, LST_CH_DT = NOW()
    	WHERE CHARGER_ID = #{chargerId}
    </update>
    
    <!-- 충전기 즉시충전가능 여부 조회 -->
    <select id="isChargerChargeAvailable" parameterType="Map" resultType="java.lang.Boolean">
		SELECT /* elcg.isChargerChargeAvailable */
        	(SELECT
       			IFNULL(SUM(CAPACITY), 0) + #{chargerWatt}
       		FROM TB_ELCG_CHARGER
       		WHERE CHARGER_GROUP_ID = ECG.CHARGER_GROUP_ID
       		  AND DETAIL_STATUS IN ('406203', '406205')
        	) &lt;= IFNULL(ECG.CAPACITY, 0)
		FROM TB_ELCG_CHARGER_GROUP ECG
		WHERE ECG.CHARGER_GROUP_ID = #{chargerGroupId}
    </select>
    
    <!-- 빌딩 충전가능여부를 조회하여 상태 업데이트 -->
    <update id="updateBdChargeAvailable" parameterType="Map">
    	UPDATE /* elcg.updateBdChargeAvailable */
    	TB_ELCG_BD
    	SET STATUS = CASE WHEN (
						SELECT
				    		COUNT(*)
						FROM TB_ELCG_CHARGER_GROUP ECG
						INNER JOIN TB_ELCG_CHARGER EC ON ECG.CHARGER_GROUP_ID = EC.CHARGER_GROUP_ID
						WHERE ECG.BD_ID = #{bdId}
						  AND EC.STATUS = '406101'
					) > 0 THEN '406101' ELSE '406103' END,
			LST_CH_USID = #{usid},
			LST_CH_DT = NOW()
		WHERE BD_ID = #{bdId}
    </update>
    
    <!-- 고장신고 상세 조회 -->
    <select id="selectBrokenReportDetail" parameterType="Long" resultType="Map">
        SELECT /* elcg.selectBrokenReportDetail */
              ebr.BD_ID as bdId
            ,  ebr.CHARGER_ID as chargerId
            , (SELECT CHARGER_GROUP_ID FROM TB_ELCG_CHARGER_GROUP WHERE BD_ID = ebr.BD_ID) chargerGroupId
            , (SELECT CAPACITY FROM TB_ELCG_CHARGER WHERE CHARGER_ID = ebr.CHARGER_ID) capacity
        FROM TB_ELCG_BROKEN_REPORT ebr
        WHERE SN_ID = #{snId}
    </select>
    
    <!-- 충전기 상태 업데이트 -->
    <update id="updateChargeStatus" parameterType="Map">
        UPDATE /* elcg.updateChargeStatus */
        TB_ELCG_CHARGER
        SET STATUS = #{status}
            , DETAIL_STATUS = #{detailStatus}
        WHERE CHARGER_ID = #{chargerId}
    </update>
</mapper>
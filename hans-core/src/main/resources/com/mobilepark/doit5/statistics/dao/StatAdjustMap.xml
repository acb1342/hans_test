<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="statAdjust">

	<!-- 한전용 통계 -->
	<select id="getKepcoPeriodCount" parameterType="map" resultType="int">
		SELECT
			COUNT(*)
		FROM
			TB_STAT_KEPCO_PERIOD, TB_ELCG_BD
		<where>
			TB_STAT_KEPCO_PERIOD.BD_ID = TB_ELCG_BD.BD_ID
			<if test="bdGroupId != null"> 
				AND BD_GROUP_ID = #{bdGroupId}
			</if>
			<if test="bdId != null"> 
				AND TB_STAT_KEPCO_PERIOD.BD_ID = #{bdId}
			</if>
			<if test="fromDate != null and toDate != null"> 
	 			AND PERIOD_YMD &gt;= #{fromDate}
	  			AND PERIOD_YMD &lt;= #{toDate}
	  			AND PERIOD_DAY = #{paymentPeriod}
	  		</if>
		</where>
	</select>
	
	<select id="getKepcoPeriodList" parameterType="map" resultType="map">
		SELECT
			START_YMD, END_YMD,
			TB_STAT_KEPCO_PERIOD.BD_GROUP_ID,
			TB_STAT_KEPCO_PERIOD.BD_GROUP_NAME,
			TB_STAT_KEPCO_PERIOD.BD_ID,
			TB_STAT_KEPCO_PERIOD.BD_NAME,
			TB_ELCG_BD.ADDR,
			PERIOD_DAY, CHARGE_AMT, CHARGE_FEE
		FROM
			TB_STAT_KEPCO_PERIOD, TB_ELCG_BD
		<where>
			TB_STAT_KEPCO_PERIOD.BD_ID = TB_ELCG_BD.BD_ID
			<if test="bdGroupId != null"> 
				AND BD_GROUP_ID = #{bdGroupId}
			</if>
			<if test="bdId != null"> 
				AND TB_STAT_KEPCO_PERIOD.BD_ID = #{bdId}
			</if>
			<if test="fromDate != null and toDate != null"> 
	 			AND PERIOD_YMD &gt;= #{fromDate}
	  			AND PERIOD_YMD &lt;= #{toDate}
	  			AND PERIOD_DAY = #{paymentPeriod}
	  		</if>
		</where>
     	LIMIT #{startRow}, #{rowPerPage}
	</select>
	
	<!-- 일별 설치자 통계 -->
	<select id="getInstallerDayCount" parameterType="map" resultType="int">
		SELECT
			COUNT(*)
		FROM
			TB_STAT_INSTALLER, TB_ELCG_CHARGER
		<where>
			TB_STAT_INSTALLER.CHARGER_ID = TB_ELCG_CHARGER.CHARGER_ID
			<if test="fromDate != null and toDate != null"> 
	 			AND DATE_FORMAT(WK_DT, '%Y%m%d') &gt;= #{fromDate}
	  			AND DATE_FORMAT(WK_DT, '%Y%m%d') &lt;= #{toDate}
	  		</if>
			<if test="wkName != null and wkName != ''"> 
	 			AND WK_NAME LIKE CONCAT('%', #{wkName}, '%')
	  		</if>
			<if test="wkUsid != null and wkUsid != ''"> 
	 			AND WK_USID = #{wkUsid}
	  		</if>
		</where>
	</select>
	
	<select id="getInstallerDayList" parameterType="map" resultType="map">
		SELECT
			SN_ID,
			WK_DT, WK_NAME,
			TB_STAT_INSTALLER.BD_GROUP_ID, TB_STAT_INSTALLER.BD_GROUP_NAME,
			TB_STAT_INSTALLER.BD_ID, TB_STAT_INSTALLER.BD_NAME,
			TB_STAT_INSTALLER.CHARGER_GROUP_ID, TB_STAT_INSTALLER.CHARGER_GROUP_NAME,
			TB_STAT_INSTALLER.CHARGER_ID, TB_STAT_INSTALLER.CHARGER_NAME, TB_ELCG_CHARGER.MGMT_NO,
			WK_TYPE, EXTRA_PAY
		FROM
			TB_STAT_INSTALLER, TB_ELCG_CHARGER
		<where>
			TB_STAT_INSTALLER.CHARGER_ID = TB_ELCG_CHARGER.CHARGER_ID
			<if test="fromDate != null and toDate != null"> 
	 			AND DATE_FORMAT(WK_DT, '%Y%m%d') &gt;= #{fromDate}
	  			AND DATE_FORMAT(WK_DT, '%Y%m%d') &lt;= #{toDate}
	  		</if>
			<if test="wkName != null and wkName != ''"> 
	 			AND WK_NAME LIKE CONCAT('%', #{wkName}, '%')
	  		</if>
			<if test="wkUsid != null and wkUsid != ''"> 
	 			AND WK_USID = #{wkUsid}
	  		</if>
		</where>
		ORDER BY SN_ID DESC
     	LIMIT #{startRow}, #{rowPerPage}
	</select>

	<!-- 월별 설치자 통계 -->
	<select id="getInstallerMonthCount" parameterType="map" resultType="int">
		SELECT
			COUNT(*)
		FROM
			TB_STAT_INSTALLER_MONTH
		<where>
			1=1
			<if test="fromDate != null and toDate != null"> 
	 			AND WK_YM &gt;= #{fromDate}
	  			AND WK_YM &lt;= #{toDate}
	  		</if>
			<if test="wkName != null and wkName != ''"> 
	 			AND WK_NAME LIKE CONCAT('%', #{wkName}, '%')
	  		</if>
			<if test="wkUsid != null and wkUsid != ''"> 
	 			AND WK_USID = #{wkUsid}
	  		</if>
		</where>
	</select>
	
	<select id="getInstallerMonthList" parameterType="map" resultType="map">
		SELECT
			SN_ID, WK_YM, WK_USID, WK_NAME, WK_TYPE, WK_CNT, EXTRA_PAY, (WK_CNT*EXTRA_PAY) AS CALC_PRICE
		FROM
			TB_STAT_INSTALLER_MONTH
		<where>
			1=1
			<if test="fromDate != null and toDate != null"> 
	 			AND WK_YM &gt;= #{fromDate}
	  			AND WK_YM &lt;= #{toDate}
	  		</if>
			<if test="wkName != null and wkName != ''"> 
	 			AND WK_NAME LIKE CONCAT('%', #{wkName}, '%')
	  		</if>
			<if test="wkUsid != null and wkUsid != ''"> 
	 			AND WK_USID = #{wkUsid}
	  		</if>
		</where>
		ORDER BY SN_ID DESC
     	LIMIT #{startRow}, #{rowPerPage}
	</select>

	<!-- 설치자 정보 / param : ChargerId   -->
	<select id="getInstallerInfo" parameterType="String" resultType="map">
		SELECT
			WK_USID, WK_NAME, CHARGER_ID, BD_ID, BD_GROUP_ID
		FROM
			TB_STAT_INSTALLER
		<where>
			1=1
			<if test="value != null"> 
	 			AND CHARGER_ID = #{value}
	  		</if>
		</where>
     	LIMIT 1
	</select>
	
	<!-- 건물주용 충전기 설치 관리 -->
	<select id="getChargerCountByLandlord" parameterType="map" resultType="int">
		SELECT
			COUNT(*)
		 FROM
			TB_ELCG_CHARGER, TB_ELCG_CHARGER_GROUP, TB_ELCG_BD_GROUP, TB_ELCG_BD, TB_MGMT_ADMIN
		<where>
			1=1
			<if test="adminId != null and adminId !=''"> 
	 			AND TB_MGMT_ADMIN.ADMIN_ID = #{adminId}
	  		</if>
			<if test="fromDate != null and fromDate != ''"> 
	 			AND DATE_FORMAT(TB_ELCG_CHARGER.FST_RG_DT, '%Y%m%d') &gt;= #{fromDate}
	 		</if>
			<if test="toDate != null and toDate != ''"> 
	  			AND DATE_FORMAT(TB_ELCG_CHARGER.FST_RG_DT, '%Y%m%d') &lt;= #{toDate}
	  		</if>
			AND
				TB_ELCG_BD.ADMIN_ID = TB_MGMT_ADMIN.ADMIN_ID
			AND
				TB_ELCG_BD.BD_GROUP_ID = TB_ELCG_BD_GROUP.BD_GROUP_ID
	  		AND
				TB_ELCG_CHARGER.CHARGER_GROUP_ID = TB_ELCG_CHARGER_GROUP.CHARGER_GROUP_ID
			AND
				TB_ELCG_CHARGER_GROUP.BD_ID = TB_ELCG_BD.BD_ID
			<if test="bdId != null and bdId != ''"> 
	  			AND TB_ELCG_CHARGER_GROUP.BD_ID = #{bdId}
	  		</if>
			<if test="bdGroupId != null and bdGroupId != ''"> 
	  			AND TB_ELCG_CHARGER_GROUP.BD_GROUP_ID = #{bdGroupId}
	  		</if>
		</where>
	</select>
	
	<select id="getChargerListByLandlord" parameterType="map" resultType="map">
		SELECT
			TB_ELCG_CHARGER.CHARGER_ID,
			TB_ELCG_CHARGER.MGMT_NO AS MGMT_NO,
			TB_MGMT_ADMIN.ADMIN_ID,
			TB_MGMT_ADMIN.NAME AS ADMIN_NAME,
			TB_ELCG_CHARGER.FST_RG_USID,
			TB_ELCG_CHARGER.FST_RG_DT,
			TB_ELCG_BD_GROUP.NAME AS BD_GROUP_NAME,
			TB_ELCG_BD.NAME AS BD_NAME,
			TB_ELCG_CHARGER_GROUP.NAME AS CHARGER_GROUP_NAME,
			TB_ELCG_CHARGER.STATUS
		 FROM
			TB_ELCG_CHARGER, TB_ELCG_CHARGER_GROUP, TB_ELCG_BD_GROUP, TB_ELCG_BD, TB_MGMT_ADMIN
		<where>
			1=1
			<if test="adminId != null and adminId !=''"> 
	 			AND TB_MGMT_ADMIN.ADMIN_ID = #{adminId}
	  		</if>
			<if test="fromDate != null and fromDate != ''"> 
	 			AND DATE_FORMAT(TB_ELCG_CHARGER.FST_RG_DT, '%Y%m%d') &gt;= #{fromDate}
	 		</if>
			<if test="toDate != null and toDate != ''"> 
	  			AND DATE_FORMAT(TB_ELCG_CHARGER.FST_RG_DT, '%Y%m%d') &lt;= #{toDate}
	  		</if>
			AND
				TB_ELCG_BD.ADMIN_ID = TB_MGMT_ADMIN.ADMIN_ID
			AND
				TB_ELCG_BD.BD_GROUP_ID = TB_ELCG_BD_GROUP.BD_GROUP_ID
	  		AND
				TB_ELCG_CHARGER.CHARGER_GROUP_ID = TB_ELCG_CHARGER_GROUP.CHARGER_GROUP_ID
			AND
				TB_ELCG_CHARGER_GROUP.BD_ID = TB_ELCG_BD.BD_ID
			<if test="bdId != null and bdId != ''"> 
	  			AND TB_ELCG_CHARGER_GROUP.BD_ID = #{bdId}
	  		</if>
			<if test="bdGroupId != null and bdGroupId != ''"> 
	  			AND TB_ELCG_CHARGER_GROUP.BD_GROUP_ID = #{bdGroupId}
	  		</if>
		</where>
		ORDER BY TB_ELCG_CHARGER.FST_RG_DT DESC
     	LIMIT #{startRow}, #{rowPerPage}
	</select>
	
	<!-- 설치자용 충전 그룹 관리 -->
	<select id="getForInstallerChargerGroupCount" parameterType="map" resultType="int">
		SELECT COUNT(*) FROM (
		SELECT
			MAX(TB_ELCG_CHARGER_GROUP.CHARGER_GROUP_ID) AS CHARGER_GROUP_ID,
			MAX(TB_ELCG_CHARGER_GROUP.FST_RG_DT) AS FST_RG_DT,
			VI_ELCG_CUST_CENTER.BD_GROUP_NAME,
			VI_ELCG_CUST_CENTER.BD_NAME,
			TB_ELCG_CHARGER_GROUP.NAME,
			MAX(VI_ELCG_CUST_CENTER.WK_DT) AS WK_DT,
			COUNT(TB_ELCG_CHARGER.CHARGER_ID) AS CNT
		FROM
			TB_ELCG_CHARGER_GROUP, VI_ELCG_CUST_CENTER, TB_ELCG_CHARGER
		<where>
			1=1
		<if test="wkUsid != null and wkUsid != ''">
		AND
			VI_ELCG_CUST_CENTER.WK_USID = #{wkUsid}
		</if>
		AND
			TB_ELCG_CHARGER_GROUP.BD_ID = VI_ELCG_CUST_CENTER.BD_ID
		AND
			TB_ELCG_CHARGER_GROUP.BD_GROUP_ID = VI_ELCG_CUST_CENTER.BD_GROUP_ID
		AND
			TB_ELCG_CHARGER_GROUP.CHARGER_GROUP_ID = TB_ELCG_CHARGER.CHARGER_GROUP_ID
		</where>
		GROUP BY
			VI_ELCG_CUST_CENTER.BD_GROUP_NAME,
			VI_ELCG_CUST_CENTER.BD_NAME,
			TB_ELCG_CHARGER_GROUP.NAME
		) A
	</select>
	
	<select id="getForInstallerChargerGroupList" parameterType="map" resultType="map">
		SELECT
			MAX(TB_ELCG_CHARGER_GROUP.CHARGER_GROUP_ID) AS CHARGER_GROUP_ID,
			MAX(TB_ELCG_CHARGER_GROUP.FST_RG_DT) AS FST_RG_DT,
			VI_ELCG_CUST_CENTER.BD_GROUP_NAME,
			VI_ELCG_CUST_CENTER.BD_NAME,
			TB_ELCG_CHARGER_GROUP.NAME,
			MAX(VI_ELCG_CUST_CENTER.WK_DT) AS WK_DT,
			COUNT(TB_ELCG_CHARGER.CHARGER_ID) AS CNT
		FROM
			TB_ELCG_CHARGER_GROUP, VI_ELCG_CUST_CENTER, TB_ELCG_CHARGER
		<where>
			1=1
		<if test="wkUsid != null and wkUsid != ''">
		AND
			VI_ELCG_CUST_CENTER.WK_USID = #{wkUsid}
		</if>
		AND
			TB_ELCG_CHARGER_GROUP.BD_ID = VI_ELCG_CUST_CENTER.BD_ID
		AND
			TB_ELCG_CHARGER_GROUP.BD_GROUP_ID = VI_ELCG_CUST_CENTER.BD_GROUP_ID
		AND
			TB_ELCG_CHARGER_GROUP.CHARGER_GROUP_ID = TB_ELCG_CHARGER.CHARGER_GROUP_ID
		</where>
		GROUP BY
			VI_ELCG_CUST_CENTER.BD_GROUP_NAME,
			VI_ELCG_CUST_CENTER.BD_NAME,
			TB_ELCG_CHARGER_GROUP.NAME
		ORDER BY TB_ELCG_CHARGER.FST_RG_DT DESC
     	LIMIT #{startRow}, #{rowPerPage}
	</select>
	
	<!-- 요금제 가격 / param : priceCode   -->
	<select id="getPriceOfType" parameterType="String" resultType="map">
		SELECT 	  
				  SN_ID
				, SET_ID
				, TITLE
				, PRICE_TYPE
				, START_YMDHHMI
				, CONCAT(SUBSTRING(START_MMDD, 1, 2), '.', SUBSTRING(START_MMDD,3, 2) ) AS START_MMDD
				, CONCAT(SUBSTRING(START_HHMI, 1, 2), ':', SUBSTRING(START_HHMI,3, 2) ) AS START_HHMI
				, CONCAT(SUBSTRING(END_MMDD, 1, 2), '.', SUBSTRING(END_MMDD,3, 2) ) AS END_MMDD
				, CONCAT(SUBSTRING(END_HHMI, 1, 2), ':', SUBSTRING(END_HHMI,3, 2) ) AS END_HHMI
				, FEE
		FROM TB_BILL_PRICE_LIST
		<where>
			SET_ID = (SELECT MAX(SET_ID) FROM TB_BILL_PRICE_LIST) /* 최상위 SET */
			<choose>
                <when test="value != null">
                    AND PRICE_TYPE = #{value}
                </when>
                <otherwise>
                    AND PRICE_TYPE = '502103'
                </otherwise>
            </choose>
		</where>
     	ORDER BY START_MMDD, START_HHMI, TITLE
	</select>
	
	<insert id="insertPriceOfType" parameterType="map">
		INSERT TB_BILL_PRICE_LIST
			(
				SET_ID
			  , TITLE
			  , PRICE_TYPE
			  <if test="priceType == '502103'">
			  , START_MMDD
			  , START_HHMI
			  , END_MMDD
			  , END_HHMI
			  </if>
			  , FEE
			  , FST_RG_USID
			  , START_YMDHHMI
			  , END_YMDHHMI
			  , LST_CH_USID
			) 
			VALUES 
			(
                #{setId} + 1
			  , #{feeName}
			  , #{priceType}
			  <if test="priceType == '502103'">
			  , CONCAT(#{smApplyPeriod}, #{sdApplyPeriod})
			  , CONCAT(#{shApplyTime}, #{smApplyTime})
			  , CONCAT(#{emApplyPeriod}, #{edApplyPeriod})
			  , CONCAT(#{ehApplyTime}, #{empplyTime})
			  </if>
			  , #{amtPrice}
			  , #{userId}
			  , CONCAT(#{applyStartDate}, #{applyStartTime})
			  , '999912312359'
			  , #{userId}
			)
	</insert>
	
	<update id="updatePriceOfTypeForOld" parameterType="map">
		UPDATE TB_BILL_PRICE_LIST SET 
			  END_YMDHHMI = CONCAT(#{applyStartDate}, #{applyStartTime})
			, LST_CH_USID = #{userId}
			, LST_CH_DT = now()
		WHERE SET_ID = #{setId}	
	</update>
	
	<insert id="insertPriceOfTypeForEtc" parameterType="map">
		INSERT INTO TB_BILL_PRICE_LIST (SET_ID, TITLE, PRICE_TYPE, START_YMDHHMI, END_YMDHHMI, FEE, FST_RG_USID, LST_CH_USID)
		SELECT #{setId}+1, TITLE, PRICE_TYPE, CONCAT(#{applyStartDate}, #{applyStartTime}), '999912312359', FEE, #{userId}, #{userId}
		FROM TB_BILL_PRICE_LIST
		WHERE PRICE_TYPE NOT IN ('502101', '502102', '502103')
			AND SET_ID = #{setId}
	</insert>
	
	<select id="getMaxSetId" resultType="int">
		SELECT MAX(SET_ID) FROM TB_BILL_PRICE_LIST
	</select>
</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hans.sses.board.dao.AppVerDaoMybatis">
	<select id="count" parameterType="Map" resultType="int">
		SELECT
			COUNT(*)
		FROM
			TBL_VERSION
		<where>
			<if test="param.os != null">
				OS = #{param.os}
			</if>
		</where>
	</select>
	
	<select id="search" parameterType="Map" resultType="Map">
		SELECT
			VERSION_SEQ AS id,
			TARGET_TYPE AS targetType,
			OS AS os,
			VER AS ver,
			URL AS url,
			UPDATE_TYPE AS updateType,
			CONTENT AS content,
			DEPLOY_YMD AS deployYmd,
			DEPLOY_HHMI AS deployHhmi,
			REG_DATE AS regDate
		FROM 
			TBL_VERSION
		<where>
			<if test="param.os != null">
				OS = #{param.os}
			</if>
		</where>
		ORDER BY VERSION_SEQ DESC
		LIMIT #{param.startRow}, #{param.rowPerPage}		
	</select>

	<select id="get" parameterType="Long" resultType="Map">
		SELECT
			VERSION_SEQ AS id,
			TARGET_TYPE AS targetType,
			OS AS os,
			VER AS ver,
			URL AS url,
			UPDATE_TYPE AS updateType,
			CONTENT AS content,
			DEPLOY_YMD AS deployYmd,
			DEPLOY_HHMI AS deployHhmi,
			REG_DATE AS regDate
		FROM
			TBL_VERSION
		WHERE
			VERSION_SEQ = #{id}
	</select>		
	
	<insert id="create" parameterType="Map" useGeneratedKeys="true" keyProperty="param.id">
		INSERT INTO TBL_VERSION
			(TARGET_TYPE, OS, VER, UPDATE_TYPE, REG_DATE
			<if test="param.url != null">, URL</if>
			<if test="param.content != null">, CONTENT</if>
			<if test="param.deployYmd != null">, DEPLOY_YMD</if>
			<if test="param.deployHhmi != null">, DEPLOY_HHMI</if>
			)
		VALUES
			(#{param.targetType}, #{param.os}, #{param.ver}, #{param.updateType}, #{param.regDate}
			<if test="param.url != null">, #{param.url}</if>
			<if test="param.content != null">, #{param.content}</if>
			<if test="param.deployYmd != null">, #{param.deployYmd}</if>
			<if test="param.deployHhmi != null">, #{param.deployHhmi}</if>
			)
	</insert>

	<update id="update" parameterType="Map">
		UPDATE
			TBL_VERSION
		SET
			TARGET_TYPE = #{param.targetType}
			, OS = #{param.os}
			, VER = #{param.ver}
			, UPDATE_TYPE = #{param.updateType}
			, REG_DATE = #{param.regDate}
			<if test="param.url != null">, URL = #{param.url}</if>
			<if test="param.content != null">, CONTENT = #{param.content}</if>
			<if test="param.deployYmd != null">, DEPLOY_YMD = #{param.deployYmd}</if>
			<if test="param.deployHhmi != null">, DEPLOY_HHMI = #{param.deployHhmi}</if>
		WHERE
			VERSION_SEQ = #{param.id}
	</update>

	<delete id="delete" parameterType="Long">
		DELETE FROM TBL_VERSION WHERE VERSION_SEQ = #{id}
	</delete>

	<!-- API 앱 버전 조회 -->
    <select id="getAppVer_api" parameterType="Map" resultType="Map">
        SELECT 
              VER as ver
            , CASE WHEN EXISTS(SELECT 1 FROM TBL_VERSION A WHERE UPDATE_TYPE = '605101' AND VER <![CDATA[ >=]]> #{param.ver} AND TARGET_TYPE = #{param.targetType} AND OS = #{param.os})
                THEN 'Y'
                ELSE 'N'
              END as verYn
            , URL as updateUrl
        FROM TBL_VERSION
        WHERE OS = #{param.os}
            AND VER <![CDATA[ >=]]> #{param.ver}
            AND TARGET_TYPE = #{param.targetType}
        ORDER BY REG_DATE DESC
        LIMIT 1
    </select>
    
</mapper>
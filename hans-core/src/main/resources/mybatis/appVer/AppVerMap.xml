<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mobilepark.doit5.board.dao.AppVerDaoMybatis">
	<select id="count" parameterType="Map" resultType="int">
		SELECT
			COUNT(*)
		FROM
			TB_BOAD_APP_VER
		<where>
			<if test="param.os != null">
				OS = #{param.os}
			</if>
		</where>
	</select>
	
	<select id="search" parameterType="Map" resultType="Map">
		SELECT
			SN_ID AS id,
			TARGET_TYPE AS targetType,
			OS AS os,
			VER AS ver,
			URL AS url,
			UPDATE_TYPE AS updateType,
			CONTENT AS content,
			DEPLOY_YMD AS deployYmd,
			DEPLOY_HHMI AS deployHhmi,
			FST_RG_USID AS fstRgUsid,
			FST_RG_DT AS fstRgDt
		FROM 
			TB_BOAD_APP_VER
		<where>
			<if test="param.os != null">
				OS = #{param.os}
			</if>
		</where>
		ORDER BY SN_ID DESC
		LIMIT #{param.startRow}, #{param.rowPerPage}		
	</select>

	<select id="get" parameterType="Long" resultType="Map">
		SELECT
			SN_ID AS id,
			TARGET_TYPE AS targetType,
			OS AS os,
			VER AS ver,
			URL AS url,
			UPDATE_TYPE AS updateType,
			CONTENT AS content,
			DEPLOY_YMD AS deployYmd,
			DEPLOY_HHMI AS deployHhmi,
			FST_RG_USID AS fstRgUsid,
			FST_RG_DT AS fstRgDt
		FROM
			TB_BOAD_APP_VER
		WHERE
			SN_ID = #{id}
	</select>		
	
	<insert id="create" parameterType="Map">
		INSERT INTO TB_BOAD_APP_VER
			(TARGET_TYPE, OS, VER, UPDATE_TYPE, FST_RG_USID, FST_RG_DT
			<if test="param.url != null">, URL</if>
			<if test="param.content != null">, CONTENT</if>
			<if test="param.deployYmd != null">, DEPLOY_YMD</if>
			<if test="param.deployHhmi != null">, DEPLOY_HHMI</if>
			)
		VALUES
			(#{param.targetType}, #{param.os}, #{param.ver}, #{param.updateType}, #{param.fstRgUsid}, #{param.fstRgDt}
			<if test="param.url != null">, #{param.url}</if>
			<if test="param.content != null">, #{param.content}</if>
			<if test="param.deployYmd != null">, #{param.deployYmd}</if>
			<if test="param.deployHhmi != null">, #{param.deployHhmi}</if>
			)
	</insert>

	<update id="update" parameterType="Map">
		UPDATE
			TB_BOAD_APP_VER
		SET
			TARGET_TYPE = #{param.targetType}
			, OS = #{param.os}
			, VER = #{param.ver}
			, UPDATE_TYPE = #{param.updateType}
			, FST_RG_USID = #{param.fstRgUsid}
			, FST_RG_DT = #{param.fstRgDt}
			<if test="param.url != null">, URL = #{param.url}</if>
			<if test="param.content != null">, CONTENT = #{param.content}</if>
			<if test="param.deployYmd != null">, DEPLOY_YMD = #{param.deployYmd}</if>
			<if test="param.deployHhmi != null">, DEPLOY_HHMI = #{param.deployHhmi}</if>
		WHERE
			SN_ID = #{param.id}
	</update>

	<delete id="delete" parameterType="Long">
		DELETE FROM TB_BOAD_APP_VER WHERE SN_ID = #{id}
	</delete>

	<!-- API 앱 버전 조회 -->
    <select id="getAppVer_api" parameterType="Map" resultType="Map">
        SELECT 
              VER as ver
            , CASE WHEN EXISTS(SELECT 1 FROM TB_BOAD_APP_VER A WHERE UPDATE_TYPE = '605101' AND VER &gt; #{param.ver} AND TARGET_TYPE = #{param.targetType} AND OS = #{param.os})
                THEN 'Y'
                ELSE 'N'
              END as verYn
            , URL as updateUrl
        FROM TB_BOAD_APP_VER
        WHERE OS = #{param.os}
            AND VER &gt; #{param.ver}
            AND TARGET_TYPE = #{param.targetType}
        ORDER BY FST_RG_DT DESC
        LIMIT 1
    </select>
</mapper>
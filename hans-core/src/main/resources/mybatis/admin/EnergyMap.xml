<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hans.sses.admin.dao.EnergyDaoMybatis">
		
	<select id="getCount" parameterType="java.util.Map" resultType="int">
	  SELECT  COUNT(*)
      	FROM TBL_LOG_INFO
      	<where>
      		<if test="param.searchType != null">
	      		<choose>
	                <when test="param.searchType == 'id' ">
	                    AND USER_SEQ like  CONCAT('%',#{param.searchValue},'%')
	                </when>
	                <otherwise>
	                    AND MACADDRESS like  CONCAT('%',#{param.searchValue},'%')
	                </otherwise>
            	</choose>
			</if>
		</where>
	</select>
	
	
	<select id="getEnergyList" parameterType="java.util.Map" resultType="java.util.Map">
	  SELECT USER_SEQ AS userSeq
      			, EVENT_TYPE AS eventType
      			, MACADDRESS AS macAddress
      			, UPTIME AS upTime
      			, SAVINGTIME AS savingTime
      			, ACC_WATT AS watt
      			, DATE_FORMAT(REG_DATE, '%Y-%m-%d %h:%m') AS regDate
      	FROM TBL_LOG_INFO
      	<where>
      		<if test="param.searchType != null">
	      		<choose>
	                <when test="param.searchType == 'id' ">
	                    AND USER_SEQ like  CONCAT('%',#{param.searchValue},'%')
	                </when>
	                <otherwise>
	                    AND EVENT_TYPE like  CONCAT('%',#{param.searchValue},'%')
	                </otherwise>
            	</choose>
			</if>
		</where>
		ORDER BY REG_DATE DESC
		LIMIT #{param.startRow}, #{param.rowPerPage}	
	</select>
	
	
	<insert id="EnergyCreate" parameterType="java.util.Map">
	  insert into TBL_LOG_INFO (EVENT_TYPE, USER_SEQ, MACADDRESS, ACC_WATT, UPTIME, SAVINGTIME, REG_DATE)
	  values (#{param.eventType},(SELECT USER_SEQ FROM TBL_USER_EQUIPMENT WHERE MACADDRESS = #{param.macAddress}),#{param.macAddress},#{param.watt},#{param.uptime},#{param.savingTime},#{param.regDate})
	</insert>
	 
	<select id="getDayEnergyList" parameterType="java.util.Map" resultType="java.util.Map">
	  SELECT USER_SEQ AS userSeq
      			, MACADDRESS AS macAddress
      			, ACC_WATT AS watt
      			, DATE_FORMAT(REG_DATE,'%Y-%m-%d') AS regDate
      			, GROUP_CONCAT( WATT SEPARATOR  ';' ) AS wattList
      			, GROUP_CONCAT( EVENT_TYPE SEPARATOR  ';' ) AS eventList
      	FROM TBL_LOG_INFO
      	<where>
      	    DATE_FORMAT(REG_DATE,'%Y%m%d') <![CDATA[>=]]> #{param.beforeday} and DATE_FORMAT(REG_DATE,'%Y%m%d') <![CDATA[<=]]> #{param.afterday}
      	
	      	<choose>
	      		<when test="param.searchType == 'user' ">
		          AND USER_SEQ = CAST(#{param.searchValue} AS INT)
	          </when>
	          <otherwise>
	             AND MACADDRESS = #{param.searchValue}
	          </otherwise>
	       </choose>
      	
		</where>
		GROUP BY regDate
		ORDER BY REG_DATE ASC
	</select>
	
	
	<select id="getMonEnergyList" parameterType="java.util.Map" resultType="java.util.Map">
	  SELECT USER_SEQ AS userSeq
      			, MACADDRESS AS macAddress
      			, ACC_WATT AS watt
      			, DATE_FORMAT(REG_DATE,'%Y-%m') AS regDate
      			, GROUP_CONCAT( WATT SEPARATOR  ';' ) AS wattList
      			, GROUP_CONCAT( EVENT_TYPE SEPARATOR  ';' ) AS eventList
      	FROM TBL_LOG_INFO
      	<where>
      	
      	    DATE_FORMAT(REG_DATE,'%Y%m') <![CDATA[>=]]> DATE_FORMAT(STR_TO_DATE(#{param.beforeday},'%Y%m%d'),'%Y%m') and DATE_FORMAT(REG_DATE,'%Y%m') <![CDATA[<]]> DATE_FORMAT(DATE_ADD(STR_TO_DATE(#{param.afterday},'%Y%m%d'),interval 1 MONTH),'%Y%m')
      	
	      	<choose>
	      		<when test="param.searchType == 'user' ">
		          AND USER_SEQ = CAST(#{param.searchValue} AS INT)
	          </when>
	          <otherwise>
	             AND MACADDRESS = #{param.searchValue}
	          </otherwise>
	       </choose>
      	
		</where>
		GROUP BY regDate
		ORDER BY REG_DATE ASC
	</select>
	

	
</mapper>
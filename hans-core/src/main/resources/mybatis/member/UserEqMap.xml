<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hans.sses.member.dao.UserEqDaoMybatis">
	
	<resultMap id="getUserResultMap" type="User">
		<id property="user_seq" column="USER_SEQ" javaType="java.lang.Long"/>
		<result property="company_seq" column="COMPANY_SEQ"/>
		<result property="birthday" column="BIRTHDAY"/>
		<result property="use_yn" column="USE_YN"/>
		<result property="user_name" column="USER_NAME"/>
		<result property="location" column="LOCATION"/>
		<result property="rssi_volume" column="RSSI_VOLUME"/>
		<result property="user_ip" column="USER_IP"/>
		<result property="user_mode" column="USER_MODE"/>
		<result property="company_name" column="COMPANY_NAME"/>
		<result property="parentName" column="PARENT_NAME"/>
	</resultMap>
	
	<select id="getUser" resultMap="getUserResultMap">
		SELECT
			USER_SEQ,
			A.COMPANY_SEQ AS COMPANY_SEQ,
			USE_YN,
			USER_NAME,
			BIRTHDAY,
			LOCATION,
			RSSI_VOLUME,
			USER_IP,
			USER_MODE,
			B.COMPANY_NAME AS COMPANY_NAME,
			(
			SELECT
				C.COMPANY_NAME
			FROM
				TBL_COMPANY_INFO C
			WHERE
				C.COMPANY_SEQ = B.PARENT_SEQ
			) AS PARENT_NAME
		FROM
			TBL_USER_INFO A, TBL_COMPANY_INFO B
		WHERE
			B.COMPANY_SEQ = A.COMPANY_SEQ
			AND
			USER_SEQ = #{userSeq}
	</select>
	
	<select id="getEquipment" resultType="Equipment">
		SELECT
			MACADDRESS AS macAddress,
			NAME AS name,
			MANUFACTURER AS manufacturer,
			MAKE_DATE AS make_date,
			ETC AS etc,
			WATT AS watt
		FROM
			TBL_EQUIPMENT_INFO
		WHERE
			MACADDRESS = #{macAddress}
	</select>
	
	<resultMap id="userEqResultMap" type="UserEq">
		<result property="seq" column="SEQ"/>
		<result property="userSeq" column="USER_SEQ"/>
		<result property="macAddress" column="MACADDRESS"/>
		<result property="volume" column="VOLUME"/>
		<result property="regDate" column="REG_DATE"/>
		<result property="modDate" column="MOD_DATE"/>
		<result property="companySeq" column="COMPANY_SEQ"/>
		<association property="user" column="USER_SEQ" javaType="User" select="getUser"/>
		<association property="equipment" column="MACADDRESS" javaType="Equipment" select="getEquipment"/>
		<collection property="equipmentList" column="MACADDRESS" javaType="java.util.ArrayList" ofType="Equipment" select="getEquipmentList"/>		
	</resultMap>
	
	<!-- <select id="search" parameterType="Map" resultMap="userEqResultMap">
		SELECT
			A.SEQ AS SEQ,
			A.USER_SEQ AS USER_SEQ,
			count(A.MACADDRESS) AS VOLUME,
			A.REG_DATE,
			A.MOD_DATE,
			B.COMPANY_SEQ AS COMPANY_SEQ
		FROM
			TBL_USER_EQUIPMENT A, TBL_USER_INFO B
		WHERE
			A.USER_SEQ = B.USER_SEQ
			AND B.COMPANY_SEQ = 4
		GROUP BY A.USER_SEQ
		ORDER BY SEQ ASC
		LIMIT #{param.startRow}, #{param.rowPerPage}
	</select>
	
	<select id="count" parameterType="Map" resultType="int">
		SELECT
			COUNT(*)
		FROM
			(
			SELECT
				A.SEQ, count(A.MACADDRESS)
			FROM
				TBL_USER_EQUIPMENT A, TBL_USER_INFO B
			WHERE
				A.USER_SEQ = B.USER_SEQ
				AND B.COMPANY_SEQ = 4
			GROUP BY A.USER_SEQ
			) CNT
	</select> -->
	
	<select id="search" parameterType="Map" resultMap="userEqResultMap">
		SELECT
			SEQ,
			USER_SEQ,
			MACADDRESS,
			VOLUME,
			REG_DATE,
			MOD_DATE
		FROM
			TBL_USER_EQUIPMENT
		WHERE
			1=1
			<if test="param.searchValue != null">
				<choose>
					<when test="param.searchType == 'user'">
						AND USER_SEQ IN (SELECT USER_SEQ FROM TBL_USER_INFO WHERE USER_NAME LIKE CONCAT ('%', #{param.searchValue}, '%'))
					</when>
					<when test="param.searchType == 'equip'">
						AND MACADDRESS IN (SELECT MACADDRESS FROM TBL_EQUIPMENT_INFO WHERE NAME LIKE CONCAT ('%', #{param.searchValue}, '%'))
					</when>
					<when test="param.searchType == 'macAddr'">
						AND MACADDRESS IN (SELECT MACADDRESS FROM TBL_EQUIPMENT_INFO WHERE MACADDRESS LIKE CONCAT (#{param.searchValue}, '%'))
					</when>
				</choose>
			</if>
		ORDER BY REG_DATE DESC
		LIMIT #{param.startRow}, #{param.rowPerPage}
	</select>
	
	<select id="count" parameterType="Map" resultType="int">
		SELECT
			COUNT(*)
		FROM
			TBL_USER_EQUIPMENT
		WHERE
			1=1
			<if test="param.searchValue != null">
				<choose>
					<when test="param.searchType == 'user'">
						AND USER_SEQ IN (SELECT USER_SEQ FROM TBL_USER_INFO WHERE USER_NAME LIKE CONCAT ('%', #{param.searchValue}, '%'))
					</when>
					<when test="param.searchType == 'equip'">
						AND MACADDRESS IN (SELECT MACADDRESS FROM TBL_EQUIPMENT_INFO WHERE NAME LIKE CONCAT ('%', #{param.searchValue}, '%'))
					</when>
					<when test="param.searchType == 'macAddr'">
						AND MACADDRESS IN (SELECT MACADDRESS FROM TBL_EQUIPMENT_INFO WHERE MACADDRESS LIKE CONCAT ('%', #{param.searchValue}, '%'))
					</when>
				</choose>
			</if>
	</select>
	
	<select id="getCompanyList" parameterType="Map" resultType="Map">
		SELECT COMPANY_SEQ AS companySeq, PARENT_SEQ AS parentSeq, SORT AS sort, COMPANY_NAME AS companyName 
		FROM TBL_COMPANY_INFO
		WHERE
			<choose>
				<when test="param != null">
					PARENT_SEQ = #{param.parentCompanySeq}
				</when>
				<otherwise>
					PARENT_SEQ IS NULL
				</otherwise>
			</choose>
	</select>
	
	<select id="getUserList" parameterType="Map" resultType="Map">
		SELECT USER_SEQ AS userSeq, USER_NAME AS userName
		FROM TBL_USER_INFO
		<where>
			<if test="param != null">
				COMPANY_SEQ = #{param.companySeq}
			</if>
		</where>
	</select>
	
	<!-- 할당 가능 장비리스트 -->
	<select id="getEquipmentList" resultType="Equipment">
		SELECT
			macaddress, name, manufacturer, make_date, etc, watt, hardwareinfo, reg_date, mod_date
		FROM
			TBL_EQUIPMENT_INFO
		WHERE
			macaddress NOT IN (SELECT MACADDRESS FROM TBL_USER_EQUIPMENT)
	</select>

	<insert id="create" parameterType="UserEq">
		INSERT INTO TBL_USER_EQUIPMENT
		(
		USER_SEQ, MACADDRESS, VOLUME, REG_DATE
		)
		VALUES
		(
		#{userEq.userSeq},
		#{userEq.macAddress},
		1,
		#{userEq.regDate}
		)
	</insert>
	
	<delete id="delete" parameterType="Long">
		DELETE FROM TBL_USER_EQUIPMENT WHERE SEQ = #{id}
	</delete>
	
	<select id="getUserSeq" parameterType="String" resultType="Map">
	  SELECT  USER_SEQ AS userSeq
      	FROM TBL_USER_EQUIPMENT
      	<where>
      	MACADDRESS = '${id}'
		</where>
	</select>
	
</mapper>